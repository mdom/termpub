#!/usr/bin/perl

use strict;
use warnings;
use Mojo::Util qw(decode encode html_unescape dumper);
use Curses;
use POSIX qw(ceil);

use lib 'lib';
use App::termpub::Epub;
use App::termpub::BookViewer;

initscr;
noecho;
cbreak;
keypad(1);
curs_set(0);

for my $filename (@ARGV) {

    my $epub = eval { App::termpub::Epub->new( filename => $filename ) };

    if ( !$epub ) {
        warn "$@\n";
        next;
    }

    App::termpub::BookViewer->new( epub => $epub )->run;
}

END {
    endwin;
}

sub select_line {
    my ( $position, @lines ) = @_;
    my ( $rows, $columns );
    getmaxyx( stdscr, $rows, $columns );
    my $len      = @lines;
    my $page     = 0;
    my $max_page = ceil( @lines / $rows ) - 1;

    my @current_lines;
    my $old_page     = -1;
    my $old_position = $position;

    while (1) {
        if ( $old_page != $page ) {
            @current_lines = @lines[
              ( $page * $rows ) .. (
                    $page == $max_page
                  ? $#lines
                  : ( $page * $rows + $rows - 1 )
              )
            ];
            clear;
            addstring( 0, 0, join( "\n", @current_lines ) );
            $old_page = $page;
        }

        if ( $old_position != $position ) {
            move( $old_position, 0 );
            clrtoeol;
            addstring( $current_lines[$old_position] . "\n" );
            $old_position = $position;
        }

        move( $position, 0 );
        clrtoeol;
        attron(A_REVERSE);
        addstring( $current_lines[$position] . "\n" );
        attroff(A_REVERSE);

        refresh;

        my $c = getchar;
        if ( $c eq KEY_NPAGE ) {
            if ( $page < $max_page ) {
                $position = 0;
                $page++;
            }
        }
        elsif ( $c eq KEY_PPAGE ) {
            if ( $page > 0 ) {
                $position = 0;
                $page--;
            }
        }
        elsif ( $c eq KEY_DOWN ) {
            if ( $position < @current_lines - 1 ) {
                $position++;
            }
            else {
                if ( $page != $max_page ) {
                    $position = 0;
                    $page++;
                }
            }
        }
        elsif ( $c eq KEY_UP ) {
            if ( $position != 0 ) {
                $position--;
            }
            else {
                if ( $page != 0 ) {
                    $position = $rows - 1;
                    $page--;
                }
            }
        }
        elsif ( $c eq "\n" ) {
            return $position;
        }
        elsif ( $c eq 'q' ) {
            return;
        }
    }

    return;
}

exit 0;
